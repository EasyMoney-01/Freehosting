<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Free Host</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;margin:0;background:#0b1324;color:#e5e7eb}
    header{padding:16px 20px;background:#111827;border-bottom:1px solid #1f2937;display:flex;justify-content:space-between;align-items:center}
    main{max-width:880px;margin:32px auto;padding:0 20px}
    h1{font-size:22px;margin:0}
    .card{background:#111827;border:1px solid #1f2937;border-radius:10px;padding:16px;margin-bottom:16px}
    input,select,button{font:inherit}
    input,select{width:100%;padding:10px;border-radius:8px;border:1px solid #374151;background:#0f172a;color:#e5e7eb;margin-top:6px}
    label{font-size:13px;color:#9ca3af}
    button{padding:10px 14px;border-radius:8px;border:1px solid #374151;background:#1f2937;color:#e5e7eb;cursor:pointer}
    button.primary{background:#2563eb;border-color:#1d4ed8}
    .row{display:flex;gap:12px}
    .row>div{flex:1}
    .muted{color:#9ca3af}
    .list{display:flex;flex-direction:column;gap:10px}
    .site{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .site-actions{display:flex;gap:8px}
    a{color:#60a5fa;text-decoration:none}
  </style>
</head>
<body>
  <header>
    <h1>Free Host</h1>
    <div id="user"></div>
  </header>
  <main>
    <div id="auth" class="card">
      <div class="row">
        <div>
          <h2>Sign up</h2>
          <label>Email<input id="su_email" type="email"></label>
          <label>Username<input id="su_username" type="text"></label>
          <label>Password<input id="su_password" type="password"></label>
          <div style="margin-top:10px"><button class="primary" id="btn_signup">Sign up</button></div>
        </div>
        <div>
          <h2>Login</h2>
          <label>Email<input id="li_email" type="email"></label>
          <label>Password<input id="li_password" type="password"></label>
          <div style="margin-top:10px"><button class="primary" id="btn_login">Login</button></div>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">Demo site is available at <code>/u/demo/hello/</code>.</div>
    </div>

    <div id="app" style="display:none">
      <div class="card">
        <h2>Create site</h2>
        <label>Site name<input id="site_name" type="text" placeholder="mysite"></label>
        <div style="margin-top:10px"><button class="primary" id="btn_create">Create</button></div>
      </div>

      <div class="card">
        <h2>Your sites</h2>
        <div id="sites" class="list"></div>
      </div>
      <div class="card">
        <h2>Deployment details</h2>
        <pre id="deploy_logs" style="background:#0f172a;padding:12px;border-radius:8px;overflow:auto;max-height:300px"></pre>
      </div>
      <div class="card">
        <h2>Services</h2>
        <div class="row">
          <div>
            <label>Name<input id="svc_name" type="text" placeholder="app"></label>
            <label>Repo<input id="svc_repo" type="text" placeholder="owner/repo"></label>
            <label>Ref<input id="svc_ref" type="text" placeholder="main"></label>
            <label>Subdir<input id="svc_subdir" type="text" placeholder=""></label>
            <label>Build command<input id="svc_build" type="text" placeholder="npm ci && npm run build"></label>
            <label>Start command<input id="svc_start" type="text" placeholder="node server.js"></label>
            <div style="margin-top:10px"><button class="primary" id="btn_create_svc">Create service</button></div>
          </div>
        </div>
        <div id="services" class="list" style="margin-top:10px"></div>
      </div>
    </div>
  </main>
  <script>
    const state = { token: localStorage.getItem('token')||'', user: JSON.parse(localStorage.getItem('user')||'null') };
    const authBox = document.getElementById('auth');
    const appBox = document.getElementById('app');
    const userEl = document.getElementById('user');
    function showAuth(){ authBox.style.display='block'; appBox.style.display='none'; userEl.textContent=''; }
    function showApp(){ authBox.style.display='none'; appBox.style.display='block'; userEl.textContent=state.user? state.user.username: ''; loadSites(); }
    function api(path, opts={}){
      const headers = Object.assign({ 'Content-Type':'application/json' }, opts.headers||{});
      if(state.token) headers['Authorization'] = 'Bearer '+state.token;
      return fetch('/api'+path, Object.assign({}, opts, { headers }));
    }
    async function signup(){
      const email = document.getElementById('su_email').value.trim();
      const username = document.getElementById('su_username').value.trim();
      const password = document.getElementById('su_password').value;
      const r = await api('/auth/signup', { method:'POST', body: JSON.stringify({ email, username, password }) });
      const j = await r.json();
      if(r.ok){ state.token=j.token; state.user=j.user; localStorage.setItem('token', state.token); localStorage.setItem('user', JSON.stringify(state.user)); showApp(); } else { alert(j.error||'error'); }
    }
    async function login(){
      const email = document.getElementById('li_email').value.trim();
      const password = document.getElementById('li_password').value;
      const r = await api('/auth/login', { method:'POST', body: JSON.stringify({ email, password }) });
      const j = await r.json();
      if(r.ok){ state.token=j.token; state.user=j.user; localStorage.setItem('token', state.token); localStorage.setItem('user', JSON.stringify(state.user)); showApp(); } else { alert(j.error||'error'); }
    }
    async function createSite(){
      const name = document.getElementById('site_name').value.trim();
      const r = await api('/sites', { method:'POST', body: JSON.stringify({ name }) });
      const j = await r.json();
      if(r.ok){ loadSites(); } else { alert(j.error||'error'); }
    }
    async function loadSites(){
      const box = document.getElementById('sites');
      box.innerHTML = '';
      const r = await api('/sites');
      const j = await r.json();
      if(!r.ok){ box.textContent = 'error'; return; }
      const list = j.sites||[];
      for(const s of list){
        const el = document.createElement('div'); el.className='site';
        const left = document.createElement('div');
        const link = document.createElement('a');
        link.href = `/u/${state.user.username}/${s.name}/`;
        link.textContent = `${s.name}`;
        left.appendChild(link);
        const acts = document.createElement('div'); acts.className='site-actions';
        const up = document.createElement('input'); up.type='file'; up.accept='.zip';
        const btnZip = document.createElement('button'); btnZip.textContent='Upload ZIP';
        btnZip.onclick = async ()=>{
          if(!up.files.length) { alert('choose zip'); return; }
          const fd = new FormData(); fd.append('bundle', up.files[0]);
          const r2 = await fetch(`/api/sites/${s.id}/deploy`, { method:'POST', headers: { Authorization: 'Bearer '+state.token }, body: fd });
          const j2 = await r2.json(); if(!r2.ok) alert(j2.error||'error'); else alert('deployed');
        };
        const btnGh = document.createElement('button'); btnGh.textContent='Deploy GitHub';
        btnGh.onclick = async ()=>{
          const repo = prompt('owner/repo'); if(!repo) return;
          const ref = prompt('ref (optional)')||undefined;
          const subdir = prompt('subdir (optional)')||undefined;
          const build_command = prompt('build command (optional, e.g., npm ci && npm run build)')||undefined;
          const output_dir = prompt('output dir (optional, e.g., dist)')||undefined;
          const body = JSON.stringify({ repo, ref, subdir, build_command, output_dir });
          const r3 = await api(`/sites/${s.id}/deploy/github`, { method:'POST', body });
          const j3 = await r3.json(); if(!r3.ok) alert(j3.error||'error'); else { alert(j3.status); loadDeployments(s.id); }
        };
        const btnList = document.createElement('button'); btnList.textContent='View Deployments';
        btnList.onclick = ()=> loadDeployments(s.id);
        acts.appendChild(up); acts.appendChild(btnZip); acts.appendChild(btnGh);
        acts.appendChild(btnList);
        el.appendChild(left); el.appendChild(acts);
        box.appendChild(el);
      }
    }
    async function loadDeployments(siteId){
      const r = await api(`/sites/${siteId}/deployments`);
      const j = await r.json();
      const logsEl = document.getElementById('deploy_logs');
      if(!r.ok){ logsEl.textContent = 'error'; return; }
      const lines = (j.deployments||[]).map(d=>`${new Date(d.created_at).toLocaleString()}  ${d.id}  ${d.source_type}  ${d.status}`);
      logsEl.textContent = lines.join('\n');
      if(j.deployments && j.deployments.length){
        const last = j.deployments[0];
        const r2 = await api(`/sites/deployments/${last.id}`);
        const j2 = await r2.json();
        if(r2.ok) logsEl.textContent += "\n\n" + (j2.logs||'');
      }
    }
    async function createService(){
      const name = document.getElementById('svc_name').value.trim();
      const repo = document.getElementById('svc_repo').value.trim();
      const ref = document.getElementById('svc_ref').value.trim();
      const subdir = document.getElementById('svc_subdir').value.trim();
      const build_command = document.getElementById('svc_build').value.trim();
      const start_command = document.getElementById('svc_start').value.trim();
      const body = JSON.stringify({ name, repo, ref, subdir, build_command, start_command });
      const r = await api('/services', { method:'POST', body });
      const j = await r.json();
      if(!r.ok) alert(j.error||'error'); else { loadServices(); }
    }
    async function loadServices(){
      const box = document.getElementById('services');
      box.innerHTML = '';
      const r = await api('/services');
      const j = await r.json();
      if(!r.ok){ box.textContent='error'; return; }
      for(const s of (j.services||[])){
        const el = document.createElement('div'); el.className='site';
        const left = document.createElement('div'); left.textContent = `${s.name} (${s.status})`;
        const acts = document.createElement('div'); acts.className='site-actions';
        const link = document.createElement('a'); link.href = `/s/${state.user.username}/${s.name}/`; link.textContent='Open';
        const btnStart = document.createElement('button'); btnStart.textContent='Start'; btnStart.onclick = async ()=>{ const r2 = await api(`/services/${s.id}/start`, { method:'POST' }); const j2 = await r2.json(); if(!r2.ok) alert(j2.error||'error'); else loadServices(); };
        const btnStop = document.createElement('button'); btnStop.textContent='Stop'; btnStop.onclick = async ()=>{ const r2 = await api(`/services/${s.id}/stop`, { method:'POST' }); const j2 = await r2.json(); if(!r2.ok) alert(j2.error||'error'); else loadServices(); };
        acts.appendChild(link); acts.appendChild(btnStart); acts.appendChild(btnStop);
        el.appendChild(left); el.appendChild(acts);
        box.appendChild(el);
      }
    }
    document.getElementById('btn_signup').onclick = signup;
    document.getElementById('btn_login').onclick = login;
    document.getElementById('btn_create').onclick = createSite;
    document.getElementById('btn_create_svc').onclick = createService;
    if(state.token && state.user) showApp(); else showAuth();
  </script>
</body>
</html>